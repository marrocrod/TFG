{% extends "base.html" %}
{% load static %}
{% block title %}Bienvenido a Mi Proyecto TFG{% endblock %}

{% block content %}
<div class="container">
    <!-- Título de la página -->
    <h1 class="mt-4 mb-4 text-center">{{ message }}</h1>
    
    {% if user.user_type == "Teacher" %}
    <div class="mb-4">
        <h2>Listado de Alumnos</h2>

        <!-- Barra de búsqueda y filtros -->
        <form method="GET" id="filterForm" class="row mb-4">
            <div class="col-md-8 mb-2">
                <input type="text" name="search" id="searchInput" class="form-control" placeholder="Buscar por nombre de usuario, nombre, apellidos o correo" value="{{ search_query }}">
            </div>
            <div class="col-md-4 mb-2">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="dropdownDegrees" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Filtrar por Grado
                    </button>
                    <div class="dropdown-menu w-100 p-2" aria-labelledby="dropdownDegrees">
                        {% for degree_code, degree_name in degrees %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="degrees" id="degree-{{ degree_code }}" value="{{ degree_code }}" {% if degree_code in selected_degrees %}checked{% endif %}>
                                <label class="form-check-label" for="degree-{{ degree_code }}">
                                    {{ degree_name }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </form>

        <!-- Contenedor para la tabla de alumnos -->
        <div id="studentListContainer">
            {% include 'partials/student_list.html' %}
        </div>
    </div>


    {% elif user.user_type == "Student" %}
    <!-- Contenido específico para estudiantes -->
    <div class="mb-4">
        <h2>Temas</h2>
        <ul>
            <li>Tema 1</li>
            <li>Tema 2</li>
            <li>Tema 3</li>
        </ul>
    </div>

    <div class="mb-4">
        <h2>Exámenes</h2>
        <ul>
            <li>Examen 1</li>
            <li>Examen 2</li>
            <li>Examen 3</li>
        </ul>
    </div>

    {% elif not user.is_authenticated%}
    <!-- Imagen grande horizontal -->
    <div class="mb-4">
        <img src="{% static 'images/img1.jpg' %}" class="img-fluid" alt="Imagen descriptiva del TFG">
    </div>
    <!-- Contenido específico para usuarios no logueados (invitados) -->
    <div class="mb-4">
        <p>
            Bienvenido a nuestra plataforma educativa. Por favor, regístrate o inicia sesión para acceder a todas las funcionalidades de la plataforma.
        </p>
    </div>

    <div class="mb-4">
        <p>
            Bienvenido a la página web de mi Trabajo de Fin de Grado (TFG). Este proyecto ha sido diseñado para facilitar la interacción entre estudiantes y profesores en un entorno académico virtual.
        </p>
    </div>

    <div class="mb-4 d-flex">
        <div class="flex-grow-1">
            <p>
                En esta plataforma, los estudiantes pueden inscribirse en diferentes cursos, acceder a materiales de estudio, realizar exámenes y unirse a grupos de trabajo.
            </p>
        </div>
        <div class="ml-4">
            <img src="{% static 'images/img2.jpg' %}" class="img-fluid" alt="Imagen explicativa">
        </div>
    </div>

    <!-- Tercer párrafo con imagen a la izquierda -->
    <div class="mb-4 d-flex">
        <div class="mr-4">
            <img src="{% static 'images/img3.jpg' %}" class="img-fluid" alt="Imagen ilustrativa">
        </div>
        <div class="flex-grow-1">
            <p>
                Este TFG tiene como meta principal la creación de una herramienta útil y funcional.
            </p>
        </div>
    </div>

    {% endif %}
</div>

<script>
document.querySelectorAll('.degree-option').forEach(function(option) {
    option.addEventListener('click', function(event) {
        event.preventDefault();
        const checkbox = this.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;

        updateStudentList();  // Llama a la función para actualizar la lista
    });
});

document.getElementById('searchInput').addEventListener('input', updateStudentList);

function updateStudentList() {
    const searchQuery = document.getElementById('searchInput').value;
    const selectedDegrees = Array.from(document.querySelectorAll('.degree-option input:checked'))
        .map(checkbox => checkbox.value);  // Usamos el value del checkbox directamente

    // Creamos una URL con los parámetros necesarios
    const url = new URL(window.location.href);
    url.searchParams.set('search', searchQuery);
    url.searchParams.delete('degrees');
    selectedDegrees.forEach(degree => {
        url.searchParams.append('degrees', degree);
    });

    // Realizamos la solicitud AJAX
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'  // Especificamos que es una solicitud AJAX
        }
    })
    .then(response => response.text())
    .then(data => {
        document.getElementById('studentListContainer').innerHTML = data;
    })
    .catch(error => console.error('Error al actualizar la lista de estudiantes:', error));
}

</script>

<style>
    .dropdown-menu {
        max-height: 300px;  /* Limita la altura para que el menú no sea demasiado largo */
        overflow-y: auto;   /* Añade barra de desplazamiento si hay muchas opciones */
    }
    
    .form-check {
        padding-left: 1.5rem;  /* Aumenta el espacio entre checkbox y label */
    }
    
    .form-check-input {
        margin-top: 0.3rem;
    }
    
    .form-check-label {
        margin-left: 0.5rem;
    }
    
</style>

{% endblock %}
